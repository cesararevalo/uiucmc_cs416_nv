<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2022 World Cup Predictions</title>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script src="https://d3js.org/d3.v7.js"></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <style>
        div#main_content {
            margin: auto;
            width: 60%;
            border: 1px solid black;
            padding: 10px;
        }
        g.annotation-subject {
            pointer-events: none;
        }
        table, th, td {
          border: 1px solid;
        }
        tr td {
          padding: 5px;
        }
        table {
          text-align: center;
        }
    </style>
</head>
<body>

<div id="main_content">

    <h1>2022 World Cup Predictions</h1>

    <p>
        The 2022 World Cup Finals will take place in Qatar starting with the group stages on November 21st and ending
        with the final on December 18th, 2022. Follow along to find out which nation is most likely to win this next
        World Cup!
    </p>

    <p>&nbsp;</p>
    <h2>FIFA's Nation Members</h2>

    <p>
        FIFA has 211 nation members, there are more nations with football teams than for any other sport, with teams representing
        191 of the 193 UN member states, as well as several dependent territories, sub-national entities, and states who are
        not members of the United Nations.[1]
    </p>
    <p>
        All of these teams could have qualified to the World Cup Finals.
        The following map shows in teal the FIFA nations members, and in grey you can see the nations which are not a part
        of FIFA, it covers almost the whole world!
    </p>

    <svg id="fifa_countries_viz" width="800" height="600"></svg>

    <p>&nbsp;</p>
    <h2>Qualified Teams & Groups</h2>
    <p>
        Out of the 211 nation teams in FIFA, only <b>32 teams</b> qualify for the World Cup finals, highlighted in orange
        here on the map.
    </p>
    <p>
        Only two nations from outside Europe and South America have made the World Cup semifinals (the United States in
        the inaugural competition in 1930 and South Korea in 2002). In 21 previous World Cups, only 13 countries have
        reached the final — all from Europe or South America — and only eight sides have won the tournament. Since 1950,
        only nine teams from outside UEFA (European soccer’s governing body) and CONMEBOL (South America’s) have reached
        the quarterfinals.[3]
    </p>
    <p>
        The following map highlights the nations which qualified to the World Cup, and hovering over them provides
        additional information from their previous participations. Can you find in the map the team that has won the
        most World Cups?
    </p>

    <svg id="wc_teams_viz" width="800" height="600"></svg>
    <div id="wc_teams_viz_tooltip" width="80" height="60"></div>

    <p>&nbsp;</p>
    <h2>Group Stage Predictions</h2>
    <p>
        For any given team the odds of winning are very small, but they are made even smaller if you are not one of the
        previous winners, a team from Europe or South America.
    </p>

    <div id="group_stage_tables">
        <h4>Group A</h4>
        <table id="group_a"></table>
        <h4>Group B</h4>
        <table id="group_b"></table>
        <h4>Group C</h4>
        <table id="group_c"></table>
        <h4>Group D</h4>
        <table id="group_d"></table>
        <h4>Group E</h4>
        <table id="group_e"></table>
        <h4>Group F</h4>
        <table id="group_f"></table>
        <h4>Group G</h4>
        <table id="group_g"></table>
        <h4>Group H</h4>
        <table id="group_h"></table>
    </div>

    <p>&nbsp;</p>
    <h2>Knockout Stage Predictions</h2>
    <p>
        ...
    </p>

    <h2>Winner!</h2>
    <p>
        ...
    </p>


    <p>&nbsp;</p><p>&nbsp;</p>
    <h1>References</h1>
    <ol>
        <li>https://en.wikipedia.org/wiki/List_of_men%27s_national_association_football_teams</li>
        <li>https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson</li>
        <li>https://fivethirtyeight.com/features/europe-and-south-america-are-growing-in-soccer-power-that-wasnt-supposed-to-happen/</li>
    </ol>

</div>

<script>

/** FIRST MAP **/
// The svg
var svg = d3.select("#fifa_countries_viz"),
  width = +svg.attr("width"),
  height = +svg.attr("height");

// Map and projection
var path = d3.geoPath();
var projection = d3.geoMercator()
  .scale(160)
  .center([10,10])
  .translate([width / 2, height / 2]);

// Data and color scale
let data = new Map();

// Load external data and boot
Promise.all([
d3.json("world.geojson"),
d3.csv("fifa_country_codes.csv", function(d) {
    data.set(d.iso_alpha_code, d.iso_id_code);
})
]).then(function(loadData) {
    let topo = loadData[0]

  // Draw the map
  svg.append("g")
    .selectAll("path")
    .data(topo.features)
    .enter()
    .append("path")
      // draw each country
      .attr("d", d3.geoPath()
        .projection(projection)
      )
      // set the color of each country
      .attr("fill", function (d) {
        if (!isNaN(data.get(d.id))) {
            return "teal";
        } else {
            return "grey";
        }
      });
});


/** SECOND MAP **/

var wc_teams_viz_tooltip = d3.select("#wc_teams_viz_tooltip");

// The svg
var wc_teams_svg = d3.select("#wc_teams_viz"),
  wc_teams_width = +wc_teams_svg.attr("width"),
  wc_teams_height = +wc_teams_svg.attr("height");

// Map and projection
var wc_teams_path = d3.geoPath();
var wc_teams_projection = d3.geoMercator()
  .scale(160)
  .center([10,10])
  .translate([wc_teams_width / 2, wc_teams_height / 2]);

// Data and color scale
let wc_teams_data = new Map();

// Load external data and boot
Promise.all([
d3.json("world.geojson"),
d3.csv("2022_wc_countries.csv", function(d) {
    wc_teams_data.set(d.iso_alpha_code, d);
})
]).then(function wc_teams_ready(loadData) {
    let topo = loadData[0];

    // Draw the map
    wc_teams_svg
        .append("g")
        .selectAll("path")
        .data(topo.features)
        .enter()
        .append("path")
          // draw each country
          .attr("d", d3.geoPath()
            .projection(wc_teams_projection)
          )
          // set the color of each country
          .attr("fill", function (d) {
            if (wc_teams_data.get(d.id)) {
                return wc_teams_data.get(d.id).color;
            } if (data.get(d.id)) {
                return "teal";
            } else {
                return "grey";
            }
          })
          // set an ID for each country path
          .attr("id", function (d) {
            return d.id;
          })
          .on("mouseover", function(d) {
                if (wc_teams_data.get(this.id) === undefined) {
                    return;
                }
                wc_teams_viz_tooltip.style("visibility", "visible");
            })
          .on("mousemove", function(d) {

                if (wc_teams_data.get(this.id) === undefined) {
                    return;
                }

                wc_teams_viz_tooltip.style("top", (event.pageY+10)+"px")
                    .style("position", "absolute")
                    .style("background", "white")
                    .style("left",(event.pageX+10)+"px")
                    .style("padding", "3px 3px 3px 3px");

                var tooltip_html = "" + wc_teams_data.get(this.id).country + " has:";
                tooltip_html += "<ul>";
                if (wc_teams_data.get(this.id).winner > 0) {
                    tooltip_html += "<li>Won " + wc_teams_data.get(this.id).winner + " times!</li>";
                }
                tooltip_html += "<li>Participated in " + wc_teams_data.get(this.id).participations + " different World Cups!</li>";
                tooltip_html += "</ul>";

                wc_teams_viz_tooltip.html(tooltip_html);
            })
          .on("mouseleave", function(){
                wc_teams_viz_tooltip.html("");
                wc_teams_viz_tooltip.style("visibility", "hidden");
            });

    wc_teams_svg.append("g").attr('pointer-event', 'none').call(makeAnnotations)

    // Add the group stage predictions
    groupStagePredictions();
});

const annotations = [
  {
    note: {
      label: "Brazil, Argentina and Uruguay have been the only non-European nations to win the Wold Cup. Winning 9 out of the 21 past World Cups.",
      title: "South America Nations"
    },
    type: d3.annotationCalloutCircle,
    subject: {
      radius: 100,         // circle radius
      radiusPadding: 60   // white space around circle befor connector
    },
    color: ["red"],
    x: 220,
    y: 390,
    dy: 10,
    dx: -100
  },
  {
    note: {
      label: "Have won 12 World Cups.",
      title: "European Nations"
    },
    type: d3.annotationCalloutCircle,
    subject: {
      radius: 60,         // circle radius
      radiusPadding: 30   // white space around circle befor connector
    },
    color: ["red"],
    x: 370,
    y: 170,
    dy: -5,
    dx: -60
  }
];

const makeAnnotations = d3.annotation().annotations(annotations);

/** Group Stage Predictions **/

var groups = ["a", "b", "c", "d", "e", "f", "g", "h"];

groups.forEach(function(group) {
    d3.select("#group_" + group).append("thead").html("<tr>" +
            "<td>Country</td>" +
            "<td>Round of 16</td>" +
            "<td>Quarter Finals</td>" +
            "<td>Semi-Finals</td>" +
            "<td>Finals</td>" +
            "<td>Wins</td>" +
            "<td>Group Stage Chance</td>" +
            "<td>Group First?</td>" +
            "<td>Group Second?</td>" +
        "</tr>");
    d3.select("#group_" + group).append("tbody");
});

function groupStagePredictions() {
    wc_teams_data.forEach(function(country) {
        d3.select("#group_" + country.wc_group.toLowerCase()).select("tbody").
            append("tr").html(
                "<td>" + country.country + "</td>" +
                "<td>" + country.round_of_16 + "</td>" +
                "<td>" + country.quarterfinals + "</td>" +
                "<td>" + country.semifinals + "</td>" +
                "<td>" + country.finals + "</td>" +
                "<td>" + country.winner + "</td>" +
                "<td id='group_" + country.wc_group.toLowerCase() + "_country_" + country.country + "'>" + parseFloat(country.chance_of_passing_round_of_16*100).toFixed(2)+"%" + "</td>" +
                "<td>" + country.first_in_group + "</td>" +
                "<td>" + country.second_in_group + "</td>"
            );
    });
};

</script>
</body>
</html>